<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>å°ç†Šç•ªèŒ„ - æ‹–æ‹½æ’åºå¢å¼ºç‰ˆ</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --app-bg: #fff7ed;
            --primary: #f97316;
            --primary-light: #ffedd5;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --white: #ffffff;
            --green: #22c55e;
            --blue: #3b82f6;
            --red: #ef4444;
            --gold: #facc15;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-dark); 
            font-family: -apple-system, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; 
            height: 100dvh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
            color: var(--text-main);
        }

        .phone-container {
            width: 100%; max-width: 414px; height: 100dvh;
            background: var(--app-bg); position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }

        header { 
            background: var(--white); 
            padding: calc(var(--safe-top) + 20px) 20px 20px; 
            border-bottom: 2px solid var(--primary-light); 
            border-radius: 0 0 40px 40px; 
            flex-shrink: 0; z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 44px; height: 44px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; position: relative; }
        .level-badge { position: absolute; bottom: -4px; right: -4px; background: var(--gold); color: #fff; font-size: 8px; font-weight: 900; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--white); }
        .title-group h1 { font-size: 16px; font-weight: 900; color: #7c2d12; }
        
        .debug-trigger { margin-left: 8px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; padding: 6px; border-radius: 8px; background: #f1f5f9; }

        .xp-bar-bg { width: 60px; height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s; }

        .checkin-label { font-size: 9px; font-weight: 900; color: var(--primary); margin-bottom: 2px; }
        .progress-bar-bg { width: 80px; height: 5px; background: #f1f5f9; border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.7s; }

        .tomato-grid { display: flex; justify-content: space-between; gap: 8px; width: 100%; margin-top: 10px; }
        .tomato-btn { flex: 1; min-width: 0; background: #f8fafc; border: 1px solid #f1f5f9; padding: 10px 2px; border-radius: 18px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.1s; }
        .tomato-btn:active { background: #f1f5f9; transform: scale(0.95); }
        .tomato-btn.green { background: #f0fdf4; border-color: #dcfce7; }
        .tomato-icon { font-size: 18px; margin-bottom: 4px; }
        .tomato-label { font-size: 8px; color: var(--text-muted); font-weight: bold; }
        .tomato-count { font-size: 12px; font-weight: 900; color: var(--text-main); }

        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 150px; }
        .view { display: none; }
        .view.active { display: block; }

        #activeTimerCard { 
            background: var(--white); border-radius: 30px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 2px solid var(--primary-light);
            text-align: center; display: none;
        }
        .timer-display { font-size: 50px; font-weight: 900; color: var(--text-main); font-variant-numeric: tabular-nums; margin: 8px 0; }
        .timer-sub { font-size: 11px; font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

        .timer-btns { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .t-btn { padding: 12px 20px; border-radius: 14px; font-size: 12px; font-weight: 900; border: none; cursor: pointer; transition: 0.2s; }
        .t-pause { background: #fef3c7; color: #d97706; }
        .t-resume { background: #dcfce7; color: #16a34a; }
        .t-cancel { background: #fee2e2; color: var(--red); }
        .t-settle { background: var(--blue); color: #fff; width: 100%; }

        /* è¡ŒåŠ¨å¡ç‰‡ & æ‹–æ‹½æ ·å¼ */
        .action-card { background: var(--white); padding: 15px; border-radius: 24px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); position: relative; cursor: grab; transition: transform 0.2s, opacity 0.2s; }
        .action-card:active { cursor: grabbing; }
        .action-card.dragging { opacity: 0.4; transform: scale(0.95); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 2px dashed var(--primary); }
        
        /* æ‹–æ‹½æŒ‡ç¤ºå™¨å›¾æ ‡ */
        .drag-handle { color: #cbd5e1; margin-right: -4px; flex-shrink: 0; display: flex; align-items: center; }

        .action-icon { width: 48px; height: 48px; background: #fff7ed; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 26px; }
        .action-info { flex: 1; min-width: 0; text-align: left; }
        .action-name { font-weight: 900; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .action-meta { font-size: 10px; color: var(--text-muted); font-weight: bold; }
        
        .play-btn { width: 44px; height: 44px; background: var(--primary); color: white; border-radius: 14px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; flex-shrink: 0; }
        .play-svg { width: 24px; height: 24px; fill: white; display: block; transform: translateX(1px); }

        .del-btn { position: absolute; top: -5px; right: -5px; background: #fee2e2; color: var(--red); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; border: none; cursor: pointer; }

        nav { 
            position: absolute; bottom: calc(var(--safe-bottom) + 20px); 
            left: 20px; right: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); 
            padding: 12px; border-radius: 30px; display: flex; justify-content: space-around; 
            border: 2px solid #ffedd5; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #cbd5e1; cursor: pointer; background: none; border: none; outline: none; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: scale(1.05); }
        .nav-item span { font-size: 8px; font-weight: 900; text-transform: uppercase; }

        .calendar-grid { display: flex; flex-wrap: wrap; gap: 5px; width: 100%; }
        .calendar-day { width: calc((100% - 30px) / 7); aspect-ratio: 1; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #94a3b8; }
        .calendar-day.checked { background: var(--primary); color: white; box-shadow: 0 3px 8px rgba(249,115,22,0.3); }

        .overlay { position: absolute; inset: 0; z-index: 600; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .prep-overlay { background: var(--primary); color: #fff; z-index: 900; }
        
        .modal-overlay { background: rgba(0,0,0,0.6); z-index: 800; padding: 24px; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-card { background: var(--white); border-radius: 35px; padding: 30px; width: 100%; text-align: center; border-bottom: 10px solid #ffedd5; }
        .modal-btns { display: flex; flex-direction: row-reverse; gap: 12px; margin-top: 25px; justify-content: center; }
        .btn-modal { flex: 1; padding: 16px; border-radius: 18px; font-weight: 900; border: none; cursor: pointer; font-size: 14px; }
        .btn-modal-ok { background: var(--primary); color: white; }
        .btn-modal-no { background: #f1f5f9; color: var(--text-muted); }

        .alarm-overlay { background: #fff; z-index: 1200; text-align: center; display: none; overflow: hidden; }
        .alarm-content { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .alarm-bg-pulse { position: absolute; inset: 0; background: radial-gradient(circle, var(--primary-light) 0%, transparent 70%); animation: bgPulse 2s infinite ease-in-out; opacity: 0.2; z-index: 1; }
        @keyframes bgPulse { 0% { transform: scale(0.8); opacity: 0.1; } 50% { transform: scale(1.5); opacity: 0.3; } 100% { transform: scale(0.8); opacity: 0.1; } }
        
        .confetti { position: absolute; width: 8px; height: 8px; border-radius: 2px; animation: confetti-fall 3s ease-in-out infinite; z-index: 2; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

        .btn-alarm-close { 
            width: 180px; 
            height: 56px; 
            background: var(--primary); 
            color: white; 
            border-radius: 28px; 
            font-weight: 900; 
            border: none; 
            cursor: pointer; 
            box-shadow: 0 10px 20px rgba(249,115,22,0.3); 
            margin-top: 30px; 
            font-size: 16px; 
        }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: var(--white); border-radius: 35px 35px 0 0; padding: 30px 24px; transform: translateY(100%); transition: transform 0.3s ease-out; border-top: 4px solid var(--primary-light); z-index: 850; display: none; }
        .bottom-sheet.active { display: block; transform: translateY(0); }
        .form-input { width: 100%; background: #f8fafc; border: 1px solid #f1f5f9; padding: 14px; border-radius: 16px; font-weight: 900; font-size: 15px; margin-bottom: 12px; outline: none; }
        .rew-selector { display: flex; gap: 6px; margin-bottom: 20px; }
        .rew-btn { flex: 1; padding: 12px 4px; border: 2px solid #f1f5f9; border-radius: 14px; font-size: 10px; font-weight: 900; background: #fff; cursor: pointer; }
        .rew-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }

        .debug-menu { 
            position: absolute; inset: 0; background: rgba(15,23,42,0.95); 
            z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 24px; 
        }
        .debug-card { background: #1e293b; width: 100%; max-width: 320px; border-radius: 30px; padding: 25px; color: white; border: 1px solid #334155; }
        .debug-btn { width: 100%; padding: 12px; background: #334155; border: none; color: white; border-radius: 12px; margin-bottom: 10px; font-weight: bold; cursor: pointer; }

        .hidden { display: none !important; }
        svg { fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
        .bear-jump { animation: bear-jump 0.6s ease infinite alternate; }
        @keyframes bear-jump { from { transform: translateY(0); } to { transform: translateY(-15px); } }
    </style>
</head>
<body id="bodyRoot">

<div class="phone-container" id="app">
    <!-- å¤´éƒ¨æ  -->
    <header>
        <div class="header-top">
            <div class="user-info">
                <div class="avatar-box"><div class="avatar" id="avatarBear">ğŸ»<div class="level-badge" id="levelDisplay">LV0</div></div></div>
                <div class="title-group" style="display:flex; align-items:center;">
                    <h1>å°ç†Šç•ªèŒ„</h1>
                    <div class="debug-trigger" onclick="app.openDebug()">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                    </div>
                </div>
            </div>
            <div class="checkin-status">
                <div class="checkin-label" id="studyLabel">è¿›åº¦ 0/15m</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="studyBarFill"></div></div>
            </div>
        </div>
        <div class="tomato-grid">
            <div class="tomato-btn" onclick="app.handleRestClick('SMALL')">
                <span class="tomato-icon">ğŸ…</span>
                <p class="tomato-label">å°ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-SMALL">0</p>
            </div>
            <div class="tomato-btn" onclick="app.handleRestClick('MEDIUM')">
                <span class="tomato-icon">ğŸ</span>
                <p class="tomato-label">ä¸­ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-MEDIUM">0</p>
            </div>
            <div class="tomato-btn" onclick="app.handleRestClick('LARGE')">
                <span class="tomato-icon">ğŸ…</span>
                <p class="tomato-label">å¤§ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-LARGE">6</p>
            </div>
            <div class="tomato-btn green" onclick="app.handleRestClick('GREEN')">
                <span class="tomato-icon">ğŸ</span>
                <p class="tomato-label">é’ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-GREEN">0</p>
            </div>
        </div>
    </header>

    <main id="mainScroll">
        <div id="activeTimerCard">
            <div class="timer-sub" id="t-mode">Focusing</div>
            <div class="timer-display" id="t-clock">25:00</div>
            <p id="t-task" style="font-size:12px; color:var(--text-muted); font-weight:900;">ä»»åŠ¡è¿›è¡Œä¸­</p>
            <div class="timer-btns" id="t-btns-normal">
                <button id="btnPause" class="t-btn t-pause" onclick="app.togglePause()">æš‚åœ</button>
                <button class="t-btn t-cancel" onclick="app.quitTimer()">å–æ¶ˆä»»åŠ¡</button>
            </div>
            <div class="timer-btns hidden" id="t-btns-pool">
                <button class="t-btn t-settle" onclick="app.finishPool()">ç»“æŸå¹¶ç»“ç®—</button>
            </div>
        </div>

        <div id="view-home" class="view active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-weight:900;">ğŸ“ è¡ŒåŠ¨æ¸…å•</h3>
                <button class="play-btn" onclick="app.openSheet()" style="width:36px; height:36px;">
                    <svg width="20" height="20" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            </div>
            <div id="actionList"></div>
            <div style="text-align:center; color:#94a3b8; font-size:9px; margin-top:20px; font-weight:bold;">ğŸ’¡ æç¤ºï¼šé•¿æŒ‰å¡ç‰‡å³å¯ä¸Šä¸‹æ‹–åŠ¨æ’åº</div>
        </div>

        <div id="view-shop" class="view">
            <div style="margin-bottom:20px;"><h3 style="font-weight:900;">â˜• è‡ªç”±ä¼‘æ¯å®¤</h3></div>
            <div style="background:#dbeafe; padding:40px 20px; border-radius:36px; text-align:center; border:2px solid #bfdbfe;">
                <p style="font-size:11px; color:#3b82f6; font-weight:900; margin-bottom:12px;">é—¨æ§›ï¼š4 ä¸ªå¤§ç•ªèŒ„</p>
                <div id="shopThreshold" style="font-size:52px; font-weight:900; color:#1d4ed8; margin-bottom:30px;">0 / 4</div>
                <button id="shopStartBtn" class="play-btn" style="width:100%; border-radius:20px; font-weight:900;" onclick="app.handlePoolClick()">å¼€å¯è‡ªç”±è®¡æ—¶</button>
            </div>
        </div>

        <div id="view-calendar" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3 style="font-weight:900;">ğŸ† æ‰“å¡æˆå°±</h3><span id="streakDisplay" style="font-size:10px; font-weight:900; color:var(--primary);">0 å¤©è¿èƒœ</span></div>
            <div style="background:#fff; padding:20px; border-radius:30px;"><div class="calendar-grid" id="calendarGrid"></div></div>
        </div>
    </main>

    <nav>
        <button class="nav-item active" onclick="app.switchTab('home', this)"><svg width="22" height="22" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>è¡ŒåŠ¨</span></button>
        <button class="nav-item" onclick="app.switchTab('shop', this)"><svg width="22" height="22" viewBox="0 0 24 24"><path d="M17 8h1a4 4 0 1 1 0 8h-1M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z M6 2v2M10 2v2M14 2v2"/></svg><span>ä¼‘æ¯</span></button>
        <button class="nav-item" onclick="app.switchTab('calendar', this)"><svg width="22" height="22" viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg><span>æˆå°±</span></button>
    </nav>

    <!-- UI: ç¡®è®¤å¼¹çª— -->
    <div class="overlay modal-overlay" id="modalUI">
        <div class="modal-card">
            <h3 id="modalTitle" style="font-weight:900; font-size:20px;">æ ‡é¢˜</h3>
            <p id="modalDesc" style="font-size:13px; color:var(--text-muted); margin:15px 0; line-height:1.5;">æè¿°æ–‡å­—</p>
            <div class="modal-btns">
                <button id="modalOkBtn" class="btn-modal btn-modal-ok">ç¡®å®š</button>
                <button class="btn-modal btn-modal-no" onclick="app.closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="overlay prep-overlay" id="prepUI"><div style="font-size:120px; font-weight:900;" id="prepNum">3</div></div>

    <!-- UI: æ—‹å¾‹é—¹é’Ÿå±‚ -->
    <div class="overlay alarm-overlay" id="alarmUI">
        <div class="alarm-bg-pulse"></div>
        <div id="confettiContainer"></div>
        <div class="alarm-content">
            <div style="font-size:80px; margin-bottom:10px;" id="alarmBearIcon">ğŸ»</div>
            <h2 style="font-weight:900; color:#7c2d12; font-size:28px;">æ—¶é—´åˆ°å•¦ï¼</h2>
            <p style="color:var(--text-muted); font-weight:bold; margin-top:5px;">å°ç†Šé™ªä½ åˆå®Œæˆäº†ä¸€æ¬¡æŒ‘æˆ˜ âœ¨</p>
            <button class="btn-alarm-close" onclick="app.closeAlarm()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- UI: åº•éƒ¨æ·»åŠ é¢æ¿ -->
    <div class="overlay" id="sheetOverlay" style="background:rgba(0,0,0,0.4);" onclick="app.closeSheet()">
        <div class="bottom-sheet" id="addSheet" onclick="event.stopPropagation()">
            <h3 style="text-align:center; font-weight:900; margin-bottom:24px;">æ–°è¡ŒåŠ¨ ğŸ»</h3>
            <input type="text" id="taskName" class="form-input" placeholder="æƒ³åšä»€ä¹ˆï¼Ÿ">
            <div style="display:grid; grid-template-cols:1fr 1fr; gap:10px;">
                <input type="number" id="taskDur" class="form-input" value="25">
                <select id="taskIcon" class="form-input"><option>ğŸƒ</option><option>ğŸ“š</option><option>ğŸ¨</option><option>ğŸ§¹</option><option>ğŸ§˜</option><option>ğŸ¹</option></select>
            </div>
            <div class="rew-selector">
                <button class="rew-btn" onclick="app.setRew('SMALL', this)">å°ç•ªèŒ„</button>
                <button class="rew-btn active" onclick="app.setRew('MEDIUM', this)">ä¸­ç•ªèŒ„</button>
                <button class="rew-btn" onclick="app.setRew('LARGE', this)">å¤§ç•ªèŒ„</button>
            </div>
            <button class="play-btn" style="width:100%; padding:18px; border-radius:18px; font-weight:900;" onclick="app.addTask()">ç¡®è®¤åˆ›å»º</button>
        </div>
    </div>

    <!-- UI: è°ƒè¯• -->
    <div class="debug-menu" id="debugUI" onclick="this.style.display='none'">
        <div class="debug-card" onclick="event.stopPropagation()">
            <h3 style="text-align:center; margin-bottom:20px;">å°ç†Šæ§åˆ¶å° ğŸ› ï¸</h3>
            <button class="debug-btn" onclick="data.addTom('LARGE', 10)">+10 å¤§ç•ªèŒ„</button>
            <button class="debug-btn" onclick="app.skip()">ç¬é—´å®Œæˆè®¡æ—¶</button>
            <button class="debug-btn" onclick="state.todayMins=15; data.checkIn(); app.render();">å¼ºåˆ¶æ‰“å¡</button>
            <button class="debug-btn" style="background:var(--red);" onclick="localStorage.clear(); location.reload();">æ ¼å¼åŒ–é‡ç½®</button>
        </div>
    </div>
</div>

<script>
    /* --- æ ¸å¿ƒå¼•æ“ (åŒ…å«æ‹–æ‹½æ’åºé€»è¾‘) --- */
    let state = {
        inv: { SMALL: 0, MEDIUM: 0, LARGE: 6, GREEN: 0 },
        xp: 0, streak: 0, lastDate: null, history: [], todayMins: 0,
        blocks: [{ id: '1', name: 'è½»é‡å®¶åŠ¡', duration: 5, reward: 'SMALL', icon: 'ğŸ ' }, { id: '2', name: 'æ·±åº¦å­¦ä¹ ', duration: 30, reward: 'LARGE', icon: 'ğŸ“š' }],
        timer: { running: false, paused: false, mode: 'work', targetEndTime: 0, pausedRemainingSec: 0, sec: 0, b: null },
        pendingRew: 'MEDIUM'
    };

    const local = localStorage.getItem('bear_v30_data');
    if (local) state = JSON.parse(local);

    let audio = null;
    let ticker = null;
    let melodyTicker = null;
    let wakeLock = null;

    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }
    function releaseWakeLock() { if (wakeLock) { wakeLock.release().then(() => { wakeLock = null; }); } }

    function initAudio() {
        if (!audio) audio = new (window.AudioContext || window.webkitAudioContext)();
        if (audio.state === 'suspended') audio.resume();
    }

    const data = {
        save() { localStorage.setItem('bear_v30_data', JSON.stringify(state)); },
        addTom(t, n) { state.inv[t] += n; this.save(); app.render(); },
        checkIn() {
            const now = new Date().toISOString().split('T')[0];
            if (state.todayMins >= 15 && state.lastDate !== now) {
                const yest = new Date(); yest.setDate(yest.getDate()-1);
                state.streak = (state.lastDate === yest.toISOString().split('T')[0]) ? state.streak + 1 : 1;
                state.lastDate = now; state.history.push(now); state.inv.GREEN++;
                this.save();
            }
        }
    };

    // æ‹–æ‹½å…¨å±€å˜é‡
    let draggedItemIdx = null;

    const app = {
        render() {
            const el = id => document.getElementById(id);
            for(let k in state.inv) { if(el(`inv-${k}`)) el(`inv-${k}`).innerText = state.inv[k]; }
            if(el('levelDisplay')) el('levelDisplay').innerText = `LV${Math.floor(state.xp/10)}`;
            if(el('xpBarFill')) el('xpBarFill').style.width = `${(state.xp%10)*10}%`;
            if(el('studyLabel')) el('studyLabel').innerText = `è¿›åº¦ ${state.todayMins}/15m`;
            if(el('studyBarFill')) el('studyBarFill').style.width = `${Math.min(100,(state.todayMins/15)*100)}%`;
            if(el('shopThreshold')) el('shopThreshold').innerText = `${state.inv.LARGE} / 4`;
            if(el('shopStartBtn')) el('shopStartBtn').style.opacity = state.inv.LARGE < 4 ? "0.3" : "1";
            if(el('streakDisplay')) el('streakDisplay').innerText = `${state.streak} å¤©è¿èƒœ`;
            this.drawBlocks(); this.drawCal(); this.updateTimerCard();
        },

        /* --- æ ¸å¿ƒæ¸²æŸ“ä¸æ‹–æ‹½ç»‘å®š --- */
        drawBlocks() {
            const list = document.getElementById('actionList'); if(!list) return; list.innerHTML = '';
            state.blocks.forEach((b, index) => {
                const div = document.createElement('div');
                div.className = 'action-card';
                div.setAttribute('draggable', 'true');
                div.setAttribute('data-index', index);
                
                // æ‹–æ‹½äº‹ä»¶ç»‘å®š
                div.addEventListener('dragstart', (e) => {
                    draggedItemIdx = index;
                    div.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                div.addEventListener('dragend', () => {
                    div.classList.remove('dragging');
                    draggedItemIdx = null;
                    document.querySelectorAll('.action-card').forEach(c => c.style.borderTop = 'none');
                });

                div.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedItemIdx === index) return;
                    e.dataTransfer.dropEffect = 'move';
                });

                div.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedItemIdx === null || draggedItemIdx === index) return;
                    
                    // æ•°ç»„ä½ç½®äº¤æ¢é€»è¾‘
                    const movedItem = state.blocks.splice(draggedItemIdx, 1)[0];
                    state.blocks.splice(index, 0, movedItem);
                    
                    data.save();
                    this.render();
                });

                // ä¸ºäº†æ›´å¥½çš„ç§»åŠ¨ç«¯ä½“éªŒï¼ŒåŠ å…¥ touch äº‹ä»¶æ¨¡æ‹Ÿæ’åº (å¯é€‰ï¼Œéƒ¨åˆ† Webview åŸç”Ÿæ”¯æŒæ‹–æ‹½)
                
                div.innerHTML = `
                    <div class="drag-handle">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path d="M5 9h14M5 15h14" stroke="#e2e8f0" stroke-width="3"/></svg>
                    </div>
                    <div class="action-icon">${b.icon}</div>
                    <div class="action-info"><div class="action-name">${b.name}</div><div class="action-meta">âŒ› ${b.duration}m Â· ğŸ ${b.reward}</div></div>
                    <button class="play-btn" onclick="app.handleWorkClick('${b.id}')">
                        <svg class="play-svg" viewBox="0 0 32 32"><path d="M10 6L26 16L10 26V6Z" /></svg>
                    </button>
                    <button class="del-btn" onclick="app.delTask('${b.id}')">âœ•</button>`;
                list.appendChild(div);
            });
        },

        drawCal() {
            const grid = document.getElementById('calendarGrid'); if(!grid) return; grid.innerHTML = '';
            const t = new Date();
            for(let i=20; i>=0; i--) {
                const d = new Date(); d.setDate(t.getDate()-i);
                const active = state.history.includes(d.toISOString().split('T')[0]);
                const div = document.createElement('div'); div.className = `calendar-day ${active ? 'checked' : ''}`;
                div.innerText = d.getDate(); grid.appendChild(div);
            }
        },

        handleIntervene(callback, title, desc) {
            initAudio();
            if (state.timer.running) {
                this.showModal('ç»ˆæ­¢å½“å‰ä»»åŠ¡ï¼Ÿ', 'åˆ‡æ¢æ–°ä»»åŠ¡ä¼šä¸¢å¼ƒå½“å‰çš„è¿›åº¦ï¼Œç¡®å®šå¼ºåˆ¶åˆ‡æ¢å—ï¼Ÿ', callback);
            } else {
                this.showModal(title, desc, callback);
            }
        },

        handleWorkClick(id) { 
            const b = state.blocks.find(x => x.id === id);
            this.handleIntervene(() => this.startWork(id), 'å¼€å¯è¡ŒåŠ¨ï¼Ÿ', `å³åˆ»å¼€å§‹ã€Œ${b.name}ã€ï¼Œæ—¶é•¿ ${b.duration} åˆ†é’Ÿã€‚`); 
        },
        handleRestClick(type) { 
            if(state.inv[type] <= 0) return;
            const ds = { SMALL:5, MEDIUM:10, LARGE:60, GREEN:30 };
            this.handleIntervene(() => this.startRest(type), 'ä½¿ç”¨ç•ªèŒ„ä¼‘æ¯ï¼Ÿ', `æ¶ˆè€— 1 ä¸ª${type}ï¼Œä¼‘æ¯ ${ds[type]} åˆ†é’Ÿã€‚`); 
        },
        handlePoolClick() {
            if(state.inv.LARGE < 4) return;
            this.handleIntervene(() => this.startPoolMode(), 'è¿›å…¥ä¼‘æ¯å®¤ï¼Ÿ', 'ç§’è¡¨æ¨¡å¼ï¼Œç»“æŸåä»åº“å­˜æ‰£é™¤ã€‚');
        },

        startWork(id) {
            const b = state.blocks.find(x => x.id === id);
            this.closeModal();
            this.prep(() => {
                requestWakeLock();
                state.timer.running = true; state.timer.paused = false; state.timer.mode = 'work';
                state.timer.sec = b.duration * 60;
                state.timer.targetEndTime = Date.now() + (b.duration * 60 * 1000);
                state.timer.b = b;
                this.launch(); this.render();
            });
        },
        startRest(type) {
            const ds = { SMALL:5, MEDIUM:10, LARGE:60, GREEN:30 };
            this.closeModal(); state.inv[type]--;
            this.prep(() => {
                requestWakeLock();
                state.timer.running = true; state.timer.paused = false; state.timer.mode = 'rest_fixed';
                state.timer.sec = ds[type] * 60;
                state.timer.targetEndTime = Date.now() + (ds[type] * 60 * 1000);
                state.timer.b = {name:'ç•ªèŒ„ä¼‘æ¯', icon:'â˜•'};
                data.save(); this.launch(); this.render();
            });
        },
        startPoolMode() {
            this.closeModal();
            this.prep(() => {
                requestWakeLock();
                state.timer.running = true; state.timer.paused = false; state.timer.mode = 'rest_pool';
                state.timer.sec = 0; state.timer.targetEndTime = Date.now();
                state.timer.b = {name:'è‡ªç”±ä¼‘æ¯', icon:'â˜•'};
                this.launch(); this.render();
            });
        },

        launch() {
            if(ticker) clearInterval(ticker);
            ticker = setInterval(() => {
                if(state.timer.running && !state.timer.paused) {
                    const now = Date.now();
                    if(state.timer.mode === 'rest_pool') {
                        state.timer.sec = Math.floor((now - state.timer.targetEndTime) / 1000);
                    } else {
                        const diff = Math.ceil((state.timer.targetEndTime - now) / 1000);
                        if(diff <= 0) { state.timer.sec = 0; this.onDone(); } else { state.timer.sec = diff; }
                    }
                    this.updateTimerCard();
                }
            }, 500); 
        },

        togglePause() {
            initAudio();
            if(!state.timer.paused) {
                state.timer.pausedRemainingSec = state.timer.sec;
                state.timer.paused = true; releaseWakeLock();
            } else {
                if(state.timer.mode === 'rest_pool') state.timer.targetEndTime = Date.now() - (state.timer.pausedRemainingSec * 1000);
                else state.timer.targetEndTime = Date.now() + (state.timer.pausedRemainingSec * 1000);
                state.timer.paused = false; requestWakeLock();
            }
            this.render();
        },

        updateTimerCard() {
            const card = document.getElementById('activeTimerCard'); if(!card) return;
            if(!state.timer.running) { card.style.display = 'none'; return; }
            card.style.display = 'block';
            const m = Math.floor(state.timer.sec/60); const s = state.timer.sec%60;
            document.getElementById('t-clock').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            document.getElementById('t-mode').innerText = state.timer.mode === 'work' ? 'Focusing' : 'Resting';
            document.getElementById('t-task').innerText = state.timer.b.name;
            const btnP = document.getElementById('btnPause');
            if(btnP) {
                btnP.innerText = state.timer.paused ? 'ç»§ç»­' : 'æš‚åœ';
                btnP.className = state.timer.paused ? 't-btn t-resume' : 't-btn t-pause';
            }
            document.getElementById('t-btns-pool').classList.toggle('hidden', state.timer.mode !== 'rest_pool');
            document.getElementById('t-btns-normal').classList.toggle('hidden', state.timer.mode === 'rest_pool');
        },

        quitTimer() { state.timer.running = false; clearInterval(ticker); releaseWakeLock(); this.render(); },
        onDone() {
            if(state.timer.mode === 'work') { state.todayMins += state.timer.b.duration; state.inv[state.timer.b.reward]++; data.checkIn(); }
            this.quitTimer(); this.triggerAlarm();
        },
        finishPool() { 
            const m = Math.ceil(state.timer.sec/60); let pay = m;
            while(pay > 0 && (state.inv.LARGE || state.inv.MEDIUM || state.inv.SMALL)) {
                if(state.inv.LARGE > 0) { state.inv.LARGE--; pay -= 60; }
                else if(state.inv.MEDIUM > 0) { state.inv.MEDIUM--; pay -= 10; }
                else if(state.inv.SMALL > 0) { state.inv.SMALL--; pay -= 5; }
                else break;
            }
            if(pay < 0) state.xp += Math.abs(pay);
            this.quitTimer(); this.triggerAlarm();
        },

        triggerAlarm() {
            initAudio();
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]); 
            document.getElementById('alarmUI').style.display='flex';
            document.getElementById('alarmBearIcon').classList.add('bear-jump');
            this.startConfetti(); this.startMelody();
        },
        startConfetti() {
            const container = document.getElementById('confettiContainer'); container.innerHTML = '';
            for(let i=0; i<30; i++) {
                const c = document.createElement('div'); c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = ['#f97316', '#facc15', '#3b82f6', '#22c55e', '#ef4444'][Math.floor(Math.random()*5)];
                c.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(c);
            }
        },
        startMelody() {
            if (melodyTicker) clearInterval(melodyTicker);
            const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 659.25];
            let idx = 0;
            melodyTicker = setInterval(() => { this.playNote(notes[idx % notes.length], 0.4, 0.25); idx++; }, 500);
        },
        playNote(f, d, volume = 0.1) {
            if(!audio) return;
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = 'triangle'; o.frequency.setValueAtTime(f, audio.currentTime);
            g.gain.setValueAtTime(0, audio.currentTime);
            g.gain.linearRampToValueAtTime(volume, audio.currentTime + 0.05);
            g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + d);
            o.connect(g); g.connect(audio.destination);
            o.start(); o.stop(audio.currentTime + d);
        },
        closeAlarm() { 
            if(melodyTicker) clearInterval(melodyTicker); 
            document.getElementById('alarmUI').style.display='none'; 
            document.getElementById('alarmBearIcon').classList.remove('bear-jump');
            this.render();
        },

        prep(cb) {
            initAudio(); const ui = document.getElementById('prepUI'); const num = document.getElementById('prepNum');
            ui.style.display = 'flex'; let c = 3; num.innerText = c;
            const t = setInterval(() => { c--; if(c<=0){ clearInterval(t); ui.style.display='none'; cb(); } else { num.innerText=c; app.playNote(440, 0.1, 0.1); } }, 1000);
        },
        showModal(title, desc, onOk) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalDesc').innerText = desc;
            document.getElementById('modalOkBtn').onclick = onOk;
            document.getElementById('modalUI').style.display = 'flex';
        },
        closeModal() { document.getElementById('modalUI').style.display = 'none'; },
        switchTab(tab, el) { initAudio(); document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(`view-${tab}`).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); },
        openSheet() { initAudio(); document.getElementById('sheetOverlay').style.display='flex'; setTimeout(()=>document.getElementById('addSheet').classList.add('active'),10); },
        closeSheet() { document.getElementById('addSheet').classList.remove('active'); setTimeout(()=>document.getElementById('sheetOverlay').style.display='none',300); },
        setRew(r, el) { state.pendingRew = r; document.querySelectorAll('.rew-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); },
        addTask() {
            const n = document.getElementById('taskName').value; if(!n) return;
            state.blocks.push({ id: Date.now().toString(), name: n, duration: parseInt(document.getElementById('taskDur').value)||25, reward: state.pendingRew, icon: document.getElementById('taskIcon').value });
            data.save(); this.render(); this.closeSheet(); document.getElementById('taskName').value = '';
        },
        delTask(id) { state.blocks = state.blocks.filter(b=>b.id!==id); data.save(); this.render(); },
        openDebug() { document.getElementById('debugUI').style.display='flex'; },
        skip() { if(state.timer.running) state.timer.targetEndTime = Date.now(); }
    };

    window.addEventListener('DOMContentLoaded', () => { app.render(); });
</script>
</body>
</html>
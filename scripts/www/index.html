<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ç†Šç•ªèŒ„ - ç»ˆæç¦»çº¿ç‰ˆ</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --app-bg: #fff7ed;
            --primary: #f97316;
            --primary-light: #ffedd5;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --white: #ffffff;
            --green: #22c55e;
            --blue: #3b82f6;
            --red: #ef4444;
            --gold: #facc15;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-dark); 
            font-family: -apple-system, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
            color: var(--text-main);
        }

        .phone-container {
            width: 100%; max-width: 414px; height: 100%; max-height: 844px;
            background: var(--app-bg); position: relative; overflow: hidden;
            display: flex; flex-direction: column; border-radius: 40px;
            border: 8px solid #000; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        header { 
            background: var(--white); 
            padding: 50px 20px 20px; 
            border-bottom: 2px solid var(--primary-light); 
            border-radius: 0 0 40px 40px; 
            flex-shrink: 0; 
            z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar-box { position: relative; }
        .avatar { width: 44px; height: 44px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .level-badge { position: absolute; bottom: -4px; right: -4px; background: var(--gold); color: #fff; font-size: 8px; font-weight: 900; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--white); }
        .title-group h1 { font-size: 16px; font-weight: 900; color: #7c2d12; }
        
        .debug-trigger { margin-left: 8px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; padding: 6px; border-radius: 8px; background: #f1f5f9; transition: background 0.2s; }
        .debug-trigger:hover { background: #e2e8f0; }

        .xp-bar-bg { width: 60px; height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s; }

        .checkin-status { text-align: right; }
        .checkin-label { font-size: 9px; font-weight: 900; color: var(--primary); margin-bottom: 2px; }
        .progress-bar-bg { width: 80px; height: 5px; background: #f1f5f9; border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.7s; }

        .tomato-grid { display: flex; justify-content: space-between; gap: 8px; width: 100%; margin-top: 10px; }
        .tomato-btn { flex: 1; min-width: 0; background: #f8fafc; border: 1px solid #f1f5f9; padding: 10px 2px; border-radius: 18px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.1s; }
        .tomato-btn:active { background: #f1f5f9; transform: scale(0.95); }
        .tomato-btn.green { background: #f0fdf4; border-color: #dcfce7; }
        .tomato-icon { font-size: 18px; margin-bottom: 4px; }
        .tomato-label { font-size: 8px; color: var(--text-muted); font-weight: bold; margin-bottom: 2px; }
        .tomato-count { font-size: 12px; font-weight: 900; color: var(--text-main); }

        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; position: relative; }
        .view { display: none; }
        .view.active { display: block; }

        #activeTimerCard { 
            background: var(--white); border-radius: 30px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 2px solid var(--primary-light);
            text-align: center; display: none; animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .timer-display { font-size: 50px; font-weight: 900; color: var(--text-main); font-variant-numeric: tabular-nums; margin: 8px 0; }
        .timer-sub { font-size: 11px; font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .timer-btns { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .t-btn { padding: 12px 20px; border-radius: 14px; font-size: 12px; font-weight: 900; border: none; cursor: pointer; transition: 0.2s; }
        .t-pause { background: #fef3c7; color: #d97706; }
        .t-resume { background: #dcfce7; color: #16a34a; }
        .t-cancel { background: #fee2e2; color: var(--red); }
        .t-settle { background: var(--blue); color: #fff; width: 100%; }

        .action-card { background: var(--white); padding: 15px; border-radius: 24px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); position: relative; }
        .action-icon { width: 48px; height: 48px; background: #fff7ed; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 26px; flex-shrink: 0; }
        .action-info { flex: 1; min-width: 0; text-align: left; }
        .action-name { font-weight: 900; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .action-meta { font-size: 10px; color: var(--text-muted); font-weight: bold; }
        .play-btn { width: 44px; height: 44px; background: var(--primary); color: white; border-radius: 14px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; flex-shrink: 0; }
        .del-btn { position: absolute; top: -5px; right: -5px; background: #fee2e2; color: var(--red); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; border: none; cursor: pointer; }

        nav { position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 12px; border-radius: 30px; display: flex; justify-content: space-around; border: 2px solid #ffedd5; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #cbd5e1; cursor: pointer; background: none; border: none; outline: none; flex: 1; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: scale(1.05); }
        .nav-item span { font-size: 8px; font-weight: 900; text-transform: uppercase; }

        .calendar-grid { display: flex; flex-wrap: wrap; gap: 5px; width: 100%; }
        .calendar-day { width: calc((100% - 30px) / 7); aspect-ratio: 1; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #94a3b8; }
        .calendar-day.checked { background: var(--primary); color: white; }

        /* å…¨å±å±‚ */
        .overlay { position: absolute; inset: 0; z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .prep-overlay { background: var(--primary); color: #fff; z-index: 600; }
        .modal-overlay { background: rgba(0,0,0,0.6); z-index: 700; padding: 24px; display: none; align-items: center; justify-content: center; }
        .modal-card { background: var(--white); border-radius: 35px; padding: 30px; width: 100%; text-align: center; border-bottom: 10px solid #ffedd5; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .btn-confirm { padding: 16px; background: var(--primary); color: white; border-radius: 18px; font-weight: 900; border: none; cursor: pointer; width: 100%; margin-top: 15px; }
        .btn-cancel-modal { background: none; border: none; color: var(--text-muted); font-weight: bold; margin-top: 15px; cursor: pointer; }

        /* é—¹é’Ÿç‰¹æ•ˆå±‚ */
        .alarm-overlay { background: #fff; z-index: 1000; text-align: center; }
        .alarm-bg-pulse { position: absolute; inset: 0; background: radial-gradient(circle, var(--primary-light) 0%, transparent 70%); animation: bgPulse 2s infinite ease-in-out; opacity: 0.5; z-index: -1; }
        @keyframes bgPulse { 0% { transform: scale(0.8); opacity: 0.3; } 50% { transform: scale(1.2); opacity: 0.6; } 100% { transform: scale(0.8); opacity: 0.3; } }

        /* è°ƒè¯•/é¢æ¿ */
        .debug-menu { position: absolute; inset: 0; background: rgba(15,23,42,0.95); z-index: 1500; display: none; align-items: center; justify-content: center; padding: 24px; overflow-y: auto; }
        .debug-card { background: #1e293b; width: 100%; border-radius: 30px; padding: 20px; color: white; border: 1px solid #334155; }
        .debug-btn { width: 100%; padding: 10px; background: #334155; border: none; color: white; border-radius: 12px; margin-bottom: 6px; font-weight: bold; cursor: pointer; }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: var(--white); border-radius: 35px 35px 0 0; padding: 30px 24px; transform: translateY(100%); transition: transform 0.3s ease-out; border-top: 4px solid var(--primary-light); z-index: 800; display: none; }
        .bottom-sheet.active { display: block; transform: translateY(0); }
        .form-input { width: 100%; background: #f8fafc; border: 1px solid #f1f5f9; padding: 14px; border-radius: 16px; font-weight: 900; font-size: 15px; margin-bottom: 12px; outline: none; }
        .rew-selector { display: flex; gap: 6px; margin-bottom: 20px; }
        .rew-btn { flex: 1; padding: 12px 4px; border: 2px solid #f1f5f9; border-radius: 14px; font-size: 10px; font-weight: 900; background: #fff; cursor: pointer; }
        .rew-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }

        .hidden { display: none !important; }
        svg { fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
    </style>
</head>
<body>

<div class="phone-container" id="app">
    <!-- å¤´éƒ¨æ  -->
    <header>
        <div class="header-top">
            <div class="user-info">
                <div class="avatar-box">
                    <div class="avatar">ğŸ»</div>
                    <div class="level-badge" id="levelDisplay">LV0</div>
                </div>
                <div class="title-group" style="display:flex; align-items:center;">
                    <h1>å°ç†Šç•ªèŒ„</h1>
                    <div class="debug-trigger" onclick="app.openDebug()">
                        <svg width="14" height="14" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                    </div>
                </div>
            </div>
            <div class="checkin-status">
                <div class="checkin-label" id="studyLabel">è¿›åº¦ 0/15m</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="studyBarFill"></div></div>
            </div>
        </div>
        <div class="tomato-grid">
            <div class="tomato-btn" onclick="app.handleRestClick('SMALL')">
                <span class="tomato-icon">ğŸ…</span>
                <p class="tomato-label">å°ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-SMALL">0</p>
            </div>
            <div class="tomato-btn" onclick="app.handleRestClick('MEDIUM')">
                <span class="tomato-icon">ğŸ</span>
                <p class="tomato-label">ä¸­ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-MEDIUM">0</p>
            </div>
            <div class="tomato-btn" onclick="app.handleRestClick('LARGE')">
                <span class="tomato-icon">ğŸ…</span>
                <p class="tomato-label">å¤§ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-LARGE">6</p>
            </div>
            <div class="tomato-btn green" onclick="app.handleRestClick('GREEN')">
                <span class="tomato-icon">ğŸ</span>
                <p class="tomato-label">é’ç•ªèŒ„</p>
                <p class="tomato-count" id="inv-GREEN">0</p>
            </div>
        </div>
    </header>

    <main id="mainScroll">
        <div id="activeTimerCard">
            <div class="timer-sub" id="t-mode">Focusing</div>
            <div class="timer-display" id="t-clock">25:00</div>
            <p id="t-task" style="font-size:12px; color:var(--text-muted); font-weight:900;">ä»»åŠ¡è¿›è¡Œä¸­</p>
            <div class="timer-btns" id="t-btns-normal">
                <button id="btnPause" class="t-btn t-pause" onclick="app.togglePause()">æš‚åœ</button>
                <button class="t-btn t-cancel" onclick="app.quitTimer()">å–æ¶ˆä»»åŠ¡</button>
            </div>
            <div class="timer-btns hidden" id="t-btns-pool">
                <button class="t-btn t-settle" onclick="app.finishPool()">ç»“æŸå¹¶ç»“ç®—</button>
            </div>
        </div>

        <div id="view-home" class="view active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-weight:900;">ğŸ“ è¡ŒåŠ¨æ¸…å•</h3>
                <button class="play-btn" onclick="app.openSheet()" style="width:36px; height:36px;">
                    <svg width="20" height="20" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            </div>
            <div id="actionList"></div>
        </div>

        <div id="view-shop" class="view">
            <div style="margin-bottom:20px;"><h3 style="font-weight:900;">â˜• è‡ªç”±ä¼‘æ¯å®¤</h3></div>
            <div style="background:#dbeafe; padding:40px 20px; border-radius:36px; text-align:center; border:2px solid #bfdbfe;">
                <p style="font-size:11px; color:#3b82f6; font-weight:900; margin-bottom:12px;">é—¨æ§›ï¼š4 ä¸ªå¤§ç•ªèŒ„</p>
                <div id="shopThreshold" style="font-size:52px; font-weight:900; color:#1d4ed8; margin-bottom:30px;">0 / 4</div>
                <button id="shopStartBtn" class="play-btn" style="width:100%; border-radius:20px; font-weight:900;" onclick="app.handlePoolClick()">å¼€å¯è‡ªç”±è®¡æ—¶</button>
            </div>
        </div>

        <div id="view-calendar" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3 style="font-weight:900;">ğŸ† æ‰“å¡æˆå°±</h3><span id="streakDisplay" style="font-size:10px; font-weight:900; color:var(--primary);">0 å¤©è¿èƒœ</span></div>
            <div style="background:#fff; padding:20px; border-radius:30px;"><div class="calendar-grid" id="calendarGrid"></div></div>
        </div>
    </main>

    <nav>
        <button class="nav-item active" onclick="app.switchTab('home', this)"><svg width="22" height="22" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>è¡ŒåŠ¨</span></button>
        <button class="nav-item" onclick="app.switchTab('shop', this)"><svg width="22" height="22" viewBox="0 0 24 24"><path d="M17 8h1a4 4 0 1 1 0 8h-1M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z M6 2v2M10 2v2M14 2v2"/></svg><span>ä¼‘æ¯</span></button>
        <button class="nav-item" onclick="app.switchTab('calendar', this)"><svg width="22" height="22" viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg><span>æˆå°±</span></button>
    </nav>

    <!-- UI: ç¡®è®¤å¼¹çª— -->
    <div class="overlay modal-overlay" id="modalUI">
        <div class="modal-card">
            <h3 id="modalTitle" style="font-weight:900; font-size:20px;">æ ‡é¢˜</h3>
            <p id="modalDesc" style="font-size:13px; color:var(--text-muted); margin:15px 0; line-height:1.5;">æè¿°æ–‡å­—</p>
            <button id="modalOkBtn" class="btn-confirm">ç¡®å®šæ‰§è¡Œ</button>
            <button class="btn-cancel-modal" onclick="app.closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="overlay prep-overlay" id="prepUI"><div style="font-size:120px; font-weight:900;" id="prepNum">3</div></div>

    <!-- UI: æ—‹å¾‹é—¹é’Ÿ -->
    <div class="overlay alarm-overlay" id="alarmUI">
        <div class="alarm-bg-pulse"></div>
        <div style="font-size:80px; margin-bottom:10px;">ğŸ»ğŸ””</div>
        <h2 style="font-weight:900; color:#7c2d12; font-size:28px;">æ—¶é—´åˆ°å•¦ï¼</h2>
        <p style="color:var(--text-muted); font-weight:bold; margin-bottom:40px;">å°ç†Šé™ªä½ åˆå®Œæˆäº†ä¸€æ¬¡æŒ‘æˆ˜ âœ¨</p>
        <button class="btn-confirm" style="width:180px; padding:20px;" onclick="app.closeAlarm()">æˆ‘çŸ¥é“äº†</button>
    </div>

    <!-- UI: åº•éƒ¨æ·»åŠ é¢æ¿ -->
    <div class="overlay" id="sheetOverlay" style="background:rgba(0,0,0,0.4);" onclick="app.closeSheet()">
        <div class="bottom-sheet" id="addSheet" onclick="event.stopPropagation()">
            <h3 style="text-align:center; font-weight:900; margin-bottom:24px;">æ–°è¡ŒåŠ¨ ğŸ»</h3>
            <input type="text" id="taskName" class="form-input" placeholder="æƒ³åšä»€ä¹ˆï¼Ÿ">
            <div style="display:grid; grid-template-cols:1fr 1fr; gap:10px;">
                <input type="number" id="taskDur" class="form-input" value="25">
                <select id="taskIcon" class="form-input"><option>ğŸƒ</option><option>ğŸ“š</option><option>ğŸ¨</option><option>ğŸ§¹</option><option>ğŸ§˜</option><option>ğŸ¹</option></select>
            </div>
            <div class="rew-selector">
                <button class="rew-btn" onclick="app.setRew('SMALL', this)">å°ç•ªèŒ„</button>
                <button class="rew-btn active" onclick="app.setRew('MEDIUM', this)">ä¸­ç•ªèŒ„</button>
                <button class="rew-btn" onclick="app.setRew('LARGE', this)">å¤§ç•ªèŒ„</button>
            </div>
            <button class="play-btn" style="width:100%; padding:18px; border-radius:18px; font-weight:900;" onclick="app.addTask()">ç¡®è®¤åˆ›å»º</button>
        </div>
    </div>

    <!-- UI: è°ƒè¯•é¢æ¿ -->
    <div class="debug-menu" id="debugUI" onclick="this.style.display='none'">
        <div class="debug-card" onclick="event.stopPropagation()">
            <h3 style="text-align:center; margin-bottom:15px;">å°ç†Šæ§åˆ¶å° ğŸ› ï¸</h3>
            <button class="debug-btn" onclick="data.addTom('LARGE', 10)">+10 å¤§ç•ªèŒ„</button>
            <button class="debug-btn" onclick="app.skip()">ç§’æ€è®¡æ—¶</button>
            <button class="debug-btn" onclick="state.todayMins=15; data.checkIn(); app.render();">å¼ºåˆ¶æ‰“å¡</button>
            <button class="debug-btn" style="background:var(--red);" onclick="localStorage.clear(); location.reload();">æ ¼å¼åŒ–é‡ç½®</button>
        </div>
    </div>
</div>

<script>
    /* --- æ ¸å¿ƒå¼•æ“ --- */
    let state = {
        inv: { SMALL: 0, MEDIUM: 0, LARGE: 6, GREEN: 0 },
        xp: 0, streak: 0, lastDate: null, history: [], todayMins: 0,
        blocks: [{ id: '1', name: 'è½»é‡å®¶åŠ¡', duration: 5, reward: 'SMALL', icon: 'ğŸ ' }, { id: '2', name: 'æ·±åº¦å­¦ä¹ ', duration: 30, reward: 'LARGE', icon: 'ğŸ“š' }],
        timer: { running: false, paused: false, mode: 'work', sec: 0, b: null },
        pendingRew: 'MEDIUM'
    };

    const local = localStorage.getItem('bear_standalone_v3');
    if (local) state = JSON.parse(local);

    const audio = new (window.AudioContext || window.webkitAudioContext)();
    let ticker = null;
    let melodyTicker = null;

    const data = {
        save() { localStorage.setItem('bear_standalone_v3', JSON.stringify(state)); },
        addTom(t, n) { state.inv[t] += n; this.save(); app.render(); },
        checkIn() {
            const now = new Date().toISOString().split('T')[0];
            if (state.todayMins >= 15 && state.lastDate !== now) {
                const yest = new Date(); yest.setDate(yest.getDate()-1);
                state.streak = (state.lastDate === yest.toISOString().split('T')[0]) ? state.streak + 1 : 1;
                state.lastDate = now; state.history.push(now); state.inv.GREEN++;
                this.save();
            }
        }
    };

    const app = {
        render() {
            const el = id => document.getElementById(id);
            for(let k in state.inv) { if(el(`inv-${k}`)) el(`inv-${k}`).innerText = state.inv[k]; }
            if(el('levelDisplay')) el('levelDisplay').innerText = `LV${Math.floor(state.xp/10)}`;
            if(el('xpBarFill')) el('xpBarFill').style.width = `${(state.xp%10)*10}%`;
            if(el('studyLabel')) el('studyLabel').innerText = `è¿›åº¦ ${state.todayMins}/15m`;
            if(el('studyBarFill')) el('studyBarFill').style.width = `${Math.min(100,(state.todayMins/15)*100)}%`;
            if(el('shopThreshold')) el('shopThreshold').innerText = `${state.inv.LARGE} / 4`;
            if(el('shopStartBtn')) el('shopStartBtn').style.opacity = state.inv.LARGE < 4 ? "0.3" : "1";
            if(el('streakDisplay')) el('streakDisplay').innerText = `${state.streak} å¤©è¿èƒœ`;
            this.drawBlocks(); this.drawCal(); this.updateTimerCard();
        },
        drawBlocks() {
            const list = document.getElementById('actionList'); if(!list) return; list.innerHTML = '';
            state.blocks.forEach(b => {
                const div = document.createElement('div'); div.className = 'action-card';
                div.innerHTML = `
                    <div class="action-icon">${b.icon}</div>
                    <div class="action-info"><div class="action-name">${b.name}</div><div class="action-meta">âŒ› ${b.duration}m Â· ğŸ ${b.reward}</div></div>
                    <button class="play-btn" onclick="app.handleWorkClick('${b.id}')"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19L19 12L6 5V19Z" /></svg></button>
                    <button class="del-btn" onclick="app.delTask('${b.id}')">âœ•</button>`;
                list.appendChild(div);
            });
        },
        drawCal() {
            const grid = document.getElementById('calendarGrid'); if(!grid) return; grid.innerHTML = '';
            const t = new Date();
            for(let i=20; i>=0; i--) {
                const d = new Date(); d.setDate(t.getDate()-i);
                const active = state.history.includes(d.toISOString().split('T')[0]);
                const div = document.createElement('div'); div.className = `calendar-day ${active ? 'checked' : ''}`;
                div.innerText = d.getDate(); grid.appendChild(div);
            }
        },

        // äº¤äº’è¯¢é—®
        checkConflict(callback, title, desc) {
            if (state.timer.running) {
                this.showModal('ç»ˆæ­¢å½“å‰ä»»åŠ¡ï¼Ÿ', 'åˆ‡æ¢æ–°ä»»åŠ¡ä¼šä¸¢å¤±å½“å‰çš„è¿›åº¦ï¼Œç¡®å®šè¦å¼ºåˆ¶åˆ‡æ¢å—ï¼Ÿ', callback);
            } else {
                this.showModal(title, desc, callback);
            }
        },

        handleWorkClick(id) { 
            const b = state.blocks.find(x => x.id === id);
            this.checkConflict(() => this.startWork(id), 'å¼€å¯è¡ŒåŠ¨ï¼Ÿ', `ä½ å³å°†å¼€å§‹ã€Œ${b.name}ã€ï¼Œæ—¶é•¿ ${b.duration} åˆ†é’Ÿã€‚`); 
        },
        handleRestClick(type) { 
            if(state.inv[type] <= 0) return;
            const durs = { SMALL:5, MEDIUM:10, LARGE:60, GREEN:30 };
            this.checkConflict(() => this.startRest(type), 'ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ', `æ¶ˆè€— 1 ä¸ª${type}ç•ªèŒ„ï¼Œè¿›è¡Œ ${durs[type]} åˆ†é’Ÿä¼‘æ¯ã€‚`); 
        },
        handlePoolClick() {
            if(state.inv.LARGE < 4) return;
            this.checkConflict(() => this.startPoolMode(), 'è¿›å…¥ä¼‘æ¯å®¤ï¼Ÿ', 'ç§’è¡¨ç»“ç®—æ¨¡å¼ï¼Œç»“æŸåè‡ªåŠ¨ä»ç•ªèŒ„åº“æŠµæŠ¼ã€‚');
        },

        startWork(id) {
            const b = state.blocks.find(x => x.id === id);
            this.closeModal();
            this.prep(() => {
                state.timer = { running: true, paused: false, mode: 'work', sec: b.duration * 60, b: b };
                this.launch(); this.render();
            });
        },
        startRest(type) {
            const ds = { SMALL:5, MEDIUM:10, LARGE:60, GREEN:30 };
            this.closeModal(); state.inv[type]--;
            state.timer = { running: true, paused: false, mode: 'rest_fixed', sec: ds[type]*60, b: {name:'ç•ªèŒ„ä¼‘æ¯', icon:'â˜•'} };
            data.save(); this.launch(); this.render();
        },
        startPoolMode() {
            this.closeModal();
            state.timer = { running: true, paused: false, mode: 'rest_pool', sec: 0, b: {name:'è‡ªç”±ä¼‘æ¯', icon:'â˜•'} };
            this.launch(); this.render();
        },

        launch() {
            if(ticker) clearInterval(ticker);
            ticker = setInterval(() => {
                if(state.timer.running && !state.timer.paused) {
                    if(state.timer.mode === 'rest_pool') state.timer.sec++;
                    else { if(state.timer.sec > 0) state.timer.sec--; else this.onDone(); }
                    this.updateTimerCard();
                }
            }, 1000);
        },
        updateTimerCard() {
            const card = document.getElementById('activeTimerCard'); if(!card) return;
            if(!state.timer.running) { card.style.display = 'none'; return; }
            card.style.display = 'block';
            const m = Math.floor(state.timer.sec/60); const s = state.timer.sec%60;
            document.getElementById('t-clock').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            document.getElementById('t-mode').innerText = state.timer.mode === 'work' ? 'Focusing' : 'Resting';
            document.getElementById('t-task').innerText = state.timer.b.name;
            const btnP = document.getElementById('btnPause');
            if(btnP) {
                btnP.innerText = state.timer.paused ? 'ç»§ç»­' : 'æš‚åœ';
                btnP.className = state.timer.paused ? 't-btn t-resume' : 't-btn t-pause';
            }
            document.getElementById('t-btns-pool').classList.toggle('hidden', state.timer.mode !== 'rest_pool');
            document.getElementById('t-btns-normal').classList.toggle('hidden', state.timer.mode === 'rest_pool');
        },
        togglePause() { state.timer.paused = !state.timer.paused; this.render(); },
        quitTimer() { state.timer.running = false; clearInterval(ticker); this.render(); },
        onDone() {
            if(state.timer.mode === 'work') {
                state.todayMins += state.timer.b.duration;
                state.inv[state.timer.b.reward]++; data.checkIn();
            }
            this.quitTimer(); this.triggerAlarm();
        },
        finishPool() { 
            const m = Math.ceil(state.timer.sec/60);
            let pay = m;
            while(pay > 0 && (state.inv.LARGE || state.inv.MEDIUM || state.inv.SMALL)) {
                if(state.inv.LARGE > 0) { state.inv.LARGE--; pay -= 60; }
                else if(state.inv.MEDIUM > 0) { state.inv.MEDIUM--; pay -= 10; }
                else if(state.inv.SMALL > 0) { state.inv.SMALL--; pay -= 5; }
                else break;
            }
            if(pay < 0) state.xp += Math.abs(pay);
            this.quitTimer(); this.triggerAlarm();
        },

        // é—¹é“ƒæ—‹å¾‹ç³»ç»Ÿ
        triggerAlarm() {
            document.getElementById('alarmUI').style.display='flex';
            this.startMelody();
        },
        startMelody() {
            if (melodyTicker) clearInterval(melodyTicker);
            const notes = [523.25, 659.25, 783.99, 1046.50, 783.99, 659.25]; // æ—‹å¾‹
            let idx = 0;
            melodyTicker = setInterval(() => {
                this.playNote(notes[idx % notes.length], 0.4);
                idx++;
            }, 500);
        },
        playNote(f, d) {
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = 'triangle'; o.frequency.setValueAtTime(f, audio.currentTime);
            g.gain.setValueAtTime(0, audio.currentTime);
            g.gain.linearRampToValueAtTime(0.08, audio.currentTime + 0.05);
            g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + d);
            o.connect(g); g.connect(audio.destination);
            o.start(); o.stop(audio.currentTime + d);
        },
        closeAlarm() { 
            if(melodyTicker) clearInterval(melodyTicker); 
            document.getElementById('alarmUI').style.display='none'; 
            this.render();
        },

        // é€šç”¨é¢æ¿æ§åˆ¶
        prep(cb) {
            const ui = document.getElementById('prepUI'); const num = document.getElementById('prepNum');
            ui.style.display = 'flex'; let c = 3; num.innerText = c;
            const t = setInterval(() => { c--; if(c<=0){ clearInterval(t); ui.style.display='none'; cb(); } else { num.innerText=c; app.playNote(440, 0.1); } }, 1000);
        },
        showModal(title, desc, onOk) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalDesc').innerText = desc;
            document.getElementById('modalOkBtn').onclick = onOk;
            document.getElementById('modalUI').style.display = 'flex';
        },
        closeModal() { document.getElementById('modalUI').style.display = 'none'; },
        switchTab(tab, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        },
        openSheet() { document.getElementById('sheetOverlay').style.display='flex'; setTimeout(()=>document.getElementById('addSheet').classList.add('active'),10); },
        closeSheet() { document.getElementById('addSheet').classList.remove('active'); setTimeout(()=>document.getElementById('sheetOverlay').style.display='none',300); },
        setRew(r, el) { state.pendingRew = r; document.querySelectorAll('.rew-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); },
        addTask() {
            const n = document.getElementById('taskName').value; if(!n) return;
            state.blocks.push({ id: Date.now().toString(), name: n, duration: parseInt(document.getElementById('taskDur').value)||25, reward: state.pendingRew, icon: document.getElementById('taskIcon').value });
            data.save(); this.render(); this.closeSheet(); document.getElementById('taskName').value = '';
        },
        delTask(id) { state.blocks = state.blocks.filter(b=>b.id!==id); data.save(); this.render(); },
        openDebug() { document.getElementById('debugUI').style.display='flex'; },
        skip() { if(state.timer.running) state.timer.sec = 1; }
    };

    window.addEventListener('DOMContentLoaded', () => { app.render(); });
</script>
</body>
</html>
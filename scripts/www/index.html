<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>å°ç†Šç•ªèŒ„ - æ‰‹æœºæè‡´é€‚é…ç‰ˆ</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --app-bg: #fff7ed;
            --primary: #f97316;
            --primary-light: #ffedd5;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --white: #ffffff;
            --green: #22c55e;
            --blue: #3b82f6;
            --red: #ef4444;
            --gold: #facc15;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* åŸºç¡€é‡ç½® - æ¶ˆé™¤ç³»ç»Ÿé»˜è®¤å¹²æ‰° */
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        body { 
            background-color: var(--bg-dark); 
            font-family: system-ui, -apple-system, "PingFang SC", sans-serif;
            height: 100dvh; display: flex; align-items: center; justify-content: center; overflow: hidden; color: var(--text-main);
        }

        .phone-container {
            width: 100%; max-width: 414px; height: 100dvh;
            background: var(--app-bg); position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* å¤´éƒ¨æ ·å¼ */
        header { 
            background: var(--white); 
            padding: calc(var(--safe-top) + 20px) 20px 20px; 
            border-bottom: 2px solid var(--primary-light); border-radius: 0 0 40px 40px; 
            flex-shrink: 0; z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; flex: 1; }
        .avatar { width: 50px; height: 50px; background: var(--primary); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 26px; position: relative; flex-shrink: 0; }
        .level-badge { position: absolute; bottom: -5px; right: -5px; background: var(--gold); color: #7c2d12; font-size: 10px; font-weight: 900; min-width: 22px; height: 22px; border-radius: 11px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--white); padding: 0 4px; }
        
        .xp-status { flex: 1; margin-left: 5px; }
        .xp-label { font-size: 10px; font-weight: 900; color: var(--text-muted); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .xp-bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--gold), #fbbf24); width: 0%; transition: width 0.5s; }

        .debug-trigger { margin-left: 8px; color: var(--text-muted); cursor: pointer; padding: 5px; }

        .checkin-status { text-align: right; min-width: 90px; }
        .checkin-label { font-size: 10px; font-weight: 900; color: var(--primary); margin-bottom: 2px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #f1f5f9; border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.7s; }

        /* ç•ªèŒ„ç½‘æ ¼ - ç§»é™¤æ–‡å­—æ ‡ç­¾ */
        .tomato-grid { display: flex; justify-content: space-between; gap: 8px; margin-top: 15px; }
        .tomato-btn { flex: 1; min-width: 0; background: #f8fafc; border: 1.5px solid #f1f5f9; padding: 12px 2px; border-radius: 20px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.15s; }
        .tomato-btn:active { transform: scale(0.95); background: #f1f5f9; }
        .tomato-btn.green { background: #f0fdf4; border: 2px solid #dcfce7; }
        .tomato-icon { font-size: 22px; margin-bottom: 2px; }
        .tomato-count { font-size: 15px; font-weight: 900; color: var(--text-main); }

        /* å†…å®¹åŒº */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 150px; }
        .view { display: none; }
        .view.active { display: block; }

        #activeTimerCard { background: var(--white); border-radius: 35px; padding: 30px; margin-bottom: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.06); border: 2.5px solid var(--primary-light); text-align: center; }
        .timer-display { font-size: 64px; font-weight: 900; color: var(--text-main); font-variant-numeric: tabular-nums; margin: 10px 0; line-height: 1; }
        .timer-sub { font-size: 12px; font-weight: 900; color: var(--primary); letter-spacing: 2px; }

        .timer-btns { display: flex; justify-content: center; gap: 12px; margin-top: 20px; }
        .t-btn { padding: 14px 24px; border-radius: 16px; font-size: 14px; font-weight: 900; border: none; cursor: pointer; background: #f1f5f9; }
        .t-pause { background: #fef3c7; color: #d97706; }
        .t-resume { background: #dcfce7; color: #16a34a; }
        .t-cancel { background: #fee2e2; color: var(--red); }
        .t-settle { background: var(--blue); color: #fff; width: 100%; border-radius: 20px; }

        .action-card { 
            background: var(--white); padding: 18px; border-radius: 28px; display: flex; align-items: center; gap: 12px; margin-bottom: 12px; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.02); position: relative; border: 1px solid #fff;
        }
        .action-card.dragging { opacity: 0.5; border: 2px dashed var(--primary); transform: scale(0.98); }
        .drag-handle { color: #cbd5e1; padding: 5px; cursor: grab; }

        .action-icon { width: 50px; height: 50px; background: #fff7ed; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .action-info { flex: 1; min-width: 0; }
        .action-name { font-weight: 900; font-size: 16px; color: var(--text-main); }
        .action-meta { font-size: 11px; color: var(--text-muted); font-weight: 700; margin-top: 2px; }
        
        .play-btn { width: 44px; height: 44px; background: var(--primary); color: white; border-radius: 15px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(249,115,22,0.2); }
        .del-btn { position: absolute; top: -6px; right: -6px; background: #fee2e2; color: var(--red); width: 26px; height: 26px; border-radius: 13px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid var(--white); cursor: pointer; font-weight: 900; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        nav { 
            position: absolute; bottom: calc(var(--safe-bottom) + 20px); left: 20px; right: 20px; 
            background: rgba(255,255,255,0.96); backdrop-filter: blur(15px); padding: 16px; border-radius: 40px; 
            display: flex; justify-content: space-around; border: 2px solid #ffedd5; box-shadow: 0 15px 35px rgba(0,0,0,0.1); z-index: 50; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; background: none; border: none; flex: 1; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: scale(1.1); }
        .nav-item span { font-size: 10px; font-weight: 900; }

        .calendar-grid { display: flex; flex-wrap: wrap; gap: 6px; width: 100%; }
        .calendar-day { width: calc((100% - 36px) / 7); aspect-ratio: 1; background: #f8fafc; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 900; color: #94a3b8; }
        .calendar-day.checked { background: var(--primary); color: white; box-shadow: 0 5px 12px rgba(249,115,22,0.3); }

        /* å¼¹çª— UI */
        .overlay { position: absolute; inset: 0; z-index: 600; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .modal-overlay { background: rgba(0,0,0,0.75); backdrop-filter: blur(5px); z-index: 1000; }
        .modal-card { background: var(--white); border-radius: 35px; padding: 35px; width: 85%; max-width: 340px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .btn-modal { flex: 1; padding: 16px; border-radius: 20px; font-weight: 900; border: none; font-size: 15px; cursor: pointer; }
        .btn-modal-ok { background: var(--primary); color: #fff; }
        .btn-modal-no { background: #f1f5f9; color: var(--text-muted); }

        /* å…¨å±å€’è®¡æ—¶ - å½’è¿˜ */
        .prep-overlay { background: var(--primary); color: #fff; z-index: 2500; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #prepNum { font-size: 160px; font-weight: 900; text-shadow: 0 10px 30px rgba(0,0,0,0.2); }

        /* é—¹é’Ÿé¡µ UI */
        .alarm-overlay { background: #fff; z-index: 2000; text-align: center; display: none; overflow: hidden; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .alarm-timer-label { position: absolute; top: 60px; font-weight: 900; color: var(--text-muted); font-size: 13px; background: #f1f5f9; padding: 8px 20px; border-radius: 25px; z-index: 2010; }
        .btn-alarm-close { position: relative; z-index: 2100; width: 240px; height: 64px; background: var(--primary) !important; color: white !important; border-radius: 32px !important; font-weight: 900 !important; cursor: pointer; font-size: 18px; box-shadow: 0 12px 30px rgba(249,115,22,0.4); margin-top: 20px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }

        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: var(--white); border-radius: 40px 40px 0 0; padding: 35px 25px; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1); border-top: 6px solid var(--primary-light); z-index: 850; }
        .bottom-sheet.active { transform: translateY(0); }
        .form-input { width: 100%; background: #f8fafc; border: 2px solid #f1f5f9; padding: 16px; border-radius: 18px; font-weight: 900; font-size: 16px; margin-bottom: 15px; outline: none; }

        .rew-selector { display: flex; gap: 8px; margin-bottom: 25px; }
        .rew-btn { flex: 1; padding: 14px 4px; border: 2.5px solid #f1f5f9; border-radius: 16px; font-size: 12px; font-weight: 900; background: #fff; cursor: pointer; transition: 0.2s; color: var(--text-muted); text-align: center; }
        .rew-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }

        /* è°ƒè¯•èœå• - å±…ä¸­ä¿®å¤ */
        .debug-menu { position: absolute; inset: 0; background: rgba(15,23,42,0.98); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .debug-card { background: #1e293b; width: 100%; max-width: 320px; border-radius: 35px; padding: 30px; color: white; box-shadow: 0 25px 60px rgba(0,0,0,0.5); }
        .debug-btn { width: 100%; padding: 14px; background: #334155; border: none; color: white; border-radius: 15px; margin-bottom: 12px; font-weight: bold; cursor: pointer; }

        .confetti-canvas { position: absolute; inset: 0; pointer-events: none; z-index: 5; }
        .melody-pulse { animation: melody-pulse 1.5s infinite; position: relative; z-index: 10; }
        @keyframes melody-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="phone-container" id="app">
    <!-- å¤´éƒ¨æ  -->
    <header>
        <div class="header-top">
            <div class="user-info">
                <div class="avatar" id="avatarBear">ğŸ»<div class="level-badge" id="lvBadge">LV0</div></div>
                <div class="xp-status">
                    <div class="xp-label"><span>ç­‰çº§ç»éªŒ</span><span id="xpText">0/6000</span></div>
                    <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpFill"></div></div>
                </div>
                <!-- ä¿®å¤æ‰³æ‰‹å›¾æ ‡ç‚¹å‡» -->
                <div class="debug-trigger" onclick="app.openDebug()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                </div>
            </div>
            <div class="checkin-status">
                <div class="checkin-label" id="progLabel">è¿›åº¦ 0/15m</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progFill"></div></div>
            </div>
        </div>
        <div class="tomato-grid">
            <!-- å·²ç§»é™¤ç•ªèŒ„ä¸‹æ–¹çš„æ–‡å­—æ ‡ç­¾ -->
            <div class="tomato-btn" onclick="app.handleRestClick('SMALL')">
                <span class="tomato-icon">ğŸ…</span><p class="tomato-count" id="inv-SMALL">0</p>
            </div>
            <div class="tomato-btn" onclick="app.handleRestClick('MEDIUM')">
                <span class="tomato-icon">ğŸ</span><p class="tomato-count" id="inv-MEDIUM">0</p>
            </div>
            <div class="tomato-btn" onclick="app.handleRestClick('LARGE')">
                <span class="tomato-icon">ğŸ…</span><p class="tomato-count" id="inv-LARGE">0</p>
            </div>
            <div class="tomato-btn green" onclick="app.handleRestClick('GREEN')">
                <span class="tomato-icon">ğŸ</span><p class="tomato-count" id="inv-GREEN">0</p>
            </div>
        </div>
    </header>

    <main id="mainScroll">
        <div id="activeTimerCard" style="display: none;">
            <div class="timer-sub" id="t-mode">FOCUSING</div>
            <div class="timer-display" id="t-clock">25:00</div>
            <p id="t-task" style="font-size:13px; color:var(--text-muted); font-weight:bold;">ä»»åŠ¡è¿›è¡Œä¸­</p>
            <div class="timer-btns" id="t-btns-normal">
                <button id="btnPause" class="t-btn t-pause" onclick="app.togglePause()">æš‚åœ</button>
                <button class="t-btn t-cancel" onclick="app.quitTimer()">å–æ¶ˆ</button>
            </div>
            <div class="timer-btns hidden" id="t-btns-pool">
                <button class="t-btn t-settle" onclick="app.finishPool()">ç»“æŸå¹¶ç»“ç®—æ”¶ç›Š</button>
            </div>
        </div>

        <div id="view-home" class="view active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-weight:900;">ğŸ“ ä¸“æ³¨è¡ŒåŠ¨</h3>
                <button class="play-btn" onclick="app.openSheet()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
            </div>
            <div id="actionList"></div>
        </div>

        <div id="view-shop" class="view">
            <h3 style="font-weight:900; margin-bottom:20px;">â˜• è‡ªç”±ä¼‘æ¯å®¤</h3>
            <div style="background:#dbeafe; padding:45px 25px; border-radius:40px; text-align:center; border:2.5px solid #bfdbfe;">
                <p style="font-size:12px; color:#3b82f6; font-weight:900; margin-bottom:15px;">å…¥åœºåˆ¸ï¼šæŒæœ‰ 4 ä¸ªå¤§ç•ªèŒ„</p>
                <div id="shopThreshold" style="font-size:56px; font-weight:900; color:#1d4ed8; margin-bottom:30px;">0 / 4</div>
                <button id="shopStartBtn" class="play-btn" style="width:100%; border-radius:24px; font-weight:900; height: 64px;" onclick="app.handlePoolClick()">å¼€å¯è‡ªç”±è®¡æ—¶</button>
            </div>
        </div>

        <div id="view-calendar" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h3 style="font-weight:900;">ğŸ† è¿èƒœè®°å½•</h3>
                <div style="text-align: right;">
                    <div id="streakDisplay" style="font-size:14px; font-weight:900; color:var(--primary);">0 å¤©è¿èƒœ</div>
                    <div id="cycleDisplay" style="font-size:10px; color:var(--text-muted); font-weight:bold;">ç¬¬ 0/30 å¤©</div>
                </div>
            </div>
            <div style="background:#fff; padding:25px; border-radius:35px; box-shadow: 0 10px 20px rgba(0,0,0,0.03);"><div class="calendar-grid" id="calendarGrid"></div></div>
        </div>
    </main>

    <nav>
        <button class="nav-item active" onclick="app.switchTab('home', this)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>è¡ŒåŠ¨</span></button>
        <button class="nav-item" onclick="app.switchTab('shop', this)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 8h1a4 4 0 1 1 0 8h-1M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z M6 2v2M10 2v2M14 2v2"/></svg><span>ä¼‘æ¯</span></button>
        <button class="nav-item" onclick="app.switchTab('calendar', this)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg><span>æ‰“å¡</span></button>
    </nav>

    <!-- å…¨å±å‡†å¤‡å€’è®¡æ—¶ -->
    <div class="overlay prep-overlay" id="prepUI">
        <div id="prepNum">3</div>
        <p style="margin-top: 20px; font-weight: 900; opacity: 0.8; letter-spacing: 2px;">å‡†å¤‡å‡ºå‘ï¼</p>
    </div>

    <!-- æ¨¡æ€æç¤ºæ¡† -->
    <div class="overlay modal-overlay" id="modalUI">
        <div class="modal-card">
            <h3 id="modalTitle" style="font-weight:900; font-size: 22px; color: #7c2d12;">æç¤º</h3>
            <p id="modalDesc" style="font-size:15px; color:var(--text-muted); margin:18px 0; line-height:1.6;">å†…å®¹</p>
            <div style="display: flex; gap: 12px; flex-direction: row-reverse;">
                <button id="modalOkBtn" class="btn-modal btn-modal-ok">ç¡®å®š</button>
                <button class="btn-modal btn-modal-no" onclick="app.closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡å®Œæˆé¡µ -->
    <div class="overlay alarm-overlay" id="alarmUI">
        <canvas class="confetti-canvas" id="confettiCanvas"></canvas>
        <div class="alarm-timer-label" id="alarmTimerLabel">20s åè‡ªåŠ¨å…³é—­</div>
        <div style="font-size:100px; margin-bottom:15px; z-index: 10;" class="melody-pulse">ğŸ»</div>
        <h2 style="font-weight:900; color:#7c2d12; font-size:34px; z-index: 10;">å®Œæˆå•¦ï¼</h2>
        <p id="alarmRewardText" style="color:var(--primary); font-weight:900; margin: 15px 0 25px; z-index: 10; font-size: 17px;"></p>
        <button class="btn-alarm-close" id="btnAlarmClose" onclick="app.closeAlarm()">æˆ‘çŸ¥é“äº†</button>
    </div>

    <div class="overlay" id="sheetOverlay" style="background:rgba(0,0,0,0.5);" onclick="app.closeSheet()">
        <div class="bottom-sheet" id="addSheet" onclick="event.stopPropagation()">
            <h3 style="text-align:center; font-weight:900; margin-bottom:25px; font-size: 20px;">æ–°ä»»åŠ¡ ğŸ»</h3>
            <input type="text" id="taskName" class="form-input" placeholder="è¾“å…¥è¦åšçš„äº‹...">
            <div style="display:grid; grid-template-cols:1fr 1fr; gap:12px;">
                <input type="number" id="taskDur" class="form-input" value="25">
                <select id="taskIcon" class="form-input"><option>ğŸƒ</option><option>ğŸ“š</option><option>ğŸ¨</option><option>ğŸ§¹</option><option>ğŸ§˜</option><option>ğŸ¹</option></select>
            </div>
            <div class="rew-selector">
                <div class="rew-btn" onclick="app.setRew('SMALL', this)">å°ç•ªèŒ„</div>
                <div class="rew-btn active" onclick="app.setRew('MEDIUM', this)">ä¸­ç•ªèŒ„</div>
                <div class="rew-btn" onclick="app.setRew('LARGE', this)">å¤§ç•ªèŒ„</div>
            </div>
            <button class="play-btn" style="width:100%; padding:18px; border-radius:22px; font-weight: 900; height: 60px;" onclick="app.addTask()">ç¡®è®¤åˆ›å»º</button>
        </div>
    </div>

    <div class="debug-menu" id="debugUI" onclick="this.style.display='none'">
        <div class="debug-card" onclick="event.stopPropagation()">
            <h3 style="text-align:center; margin-bottom:25px; color: #fff;">å¼€å‘è€…è°ƒè¯•</h3>
            <button class="debug-btn" onclick="app.skip()">âš¡ ç«‹åˆ»å®Œæˆè®¡æ—¶</button>
            <button class="debug-btn" onclick="data.simulateNextDay()">ğŸŒ… æ¨¡æ‹Ÿè¿›å…¥ä¸‹ä¸€å¤©</button>
            <button class="debug-btn" onclick="data.addXP(6000); app.render();">â• 6000 ç»éªŒ</button>
            <button class="debug-btn" style="background:var(--red);" onclick="localStorage.clear(); location.reload();">ğŸ’£ æ ¼å¼åŒ–é‡ç½®</button>
        </div>
    </div>
</div>

<script>
    /* --- æ•°æ®æŒä¹…åŒ–ä¸æ ¸å¿ƒé€»è¾‘ --- */
    let state = {
        inv: { SMALL: 0, MEDIUM: 0, LARGE: 6, GREEN: 0 },
        xp: 0, streak: 0, lastDate: null, lastRefreshDate: null,
        history: [], todayMins: 0,
        blocks: [
            { id: '1', name: 'æ·±åº¦å·¥ä½œ', duration: 25, reward: 'MEDIUM', icon: 'ğŸ“š' },
            { id: '2', name: 'æ ¸å¿ƒè®­ç»ƒ', duration: 15, reward: 'SMALL', icon: 'ğŸƒ' }
        ],
        timer: { running: false, paused: false, mode: 'work', targetEndTime: 0, pausedSec: 0, sec: 0, b: null },
        pendingRew: 'MEDIUM'
    };

    const storageKey = 'bear_mobile_core_final';
    const saved = localStorage.getItem(storageKey);
    if (saved) state = JSON.parse(saved);

    const data = {
        save() { localStorage.setItem(storageKey, JSON.stringify(state)); },
        getToday() { return new Date().toISOString().split('T')[0]; },
        getYest() { let d = new Date(); d.setDate(d.getDate() - 1); return d.toISOString().split('T')[0]; },

        refreshDaily() {
            const today = this.getToday();
            if (state.lastRefreshDate !== today) {
                state.inv.GREEN = 0; 
                state.todayMins = 0; 
                if (state.lastDate) {
                    const yest = this.getYest();
                    if (state.lastDate !== today && state.lastDate !== yest) state.streak = 0;
                }
                state.lastRefreshDate = today;
                this.save();
            }
        },

        checkIn() {
            const today = this.getToday();
            if (state.todayMins >= 15 && state.lastDate !== today) {
                const yest = this.getYest();
                if (state.lastDate === yest) state.streak++;
                else state.streak = 1;

                if (state.streak > 30) state.streak = 1;

                state.inv.GREEN += 1;
                let bonusMsg = "è·å¾— 1 ğŸé’ç•ªèŒ„";
                const bonuses = { 5: [1,0,0], 7: [1,1,0], 15: [2,0,0], 30: [10,0,0] };
                if (bonuses[state.streak]) {
                    const [l, m, s] = bonuses[state.streak];
                    state.inv.LARGE += l; state.inv.MEDIUM += m; state.inv.SMALL += s;
                    bonusMsg += ` & ${state.streak}å¤©è¿èƒœç¤¼åŒ…!`;
                }

                state.lastDate = today;
                state.history.push(today);
                this.addXP(400);
                this.save();
                return "æ‰“å¡æˆåŠŸï¼" + bonusMsg;
            }
            return null;
        },

        addXP(amt) {
            const oldLv = Math.floor(state.xp / 6000);
            state.xp += amt;
            const newLv = Math.floor(state.xp / 6000);
            if (newLv >= 100) { state.xp = 0; return; }
            for (let l = oldLv + 1; l <= newLv; l++) {
                if (l % 5 === 0) state.inv.LARGE += 1;
            }
            this.save();
        },

        simulateNextDay() {
            const d = new Date(); d.setDate(d.getDate() - 2);
            state.lastRefreshDate = d.toISOString().split('T')[0];
            if (state.lastDate === this.getToday()) state.lastDate = this.getYest();
            this.save(); location.reload();
        }
    };

    /* --- ç³»ç»Ÿç¡¬ä»¶è”åŠ¨ --- */
    let wakeLock = null;
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }
    function releaseWakeLock() {
        if (wakeLock) { wakeLock.release(); wakeLock = null; }
    }
    function doVibrate(pattern = [500, 200, 500, 200, 500]) {
        if ('vibrate' in navigator) navigator.vibrate(pattern);
    }

    /* --- éŸ³é¢‘å¼•æ“ --- */
    let audioCtx = null;
    function getAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        return audioCtx;
    }

    function playTone(freq, dur, type='sine', vol=0.1) {
        try {
            const ctx = getAudio(); const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, ctx.currentTime);
            g.gain.setValueAtTime(vol, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
            osc.connect(g); g.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + dur);
        } catch(e){}
    }

    let melodyTimer = null;
    function startMelody() {
        const notes = [523, 659, 784, 1046, 880, 784, 659, 523];
        let i = 0;
        melodyTimer = setInterval(() => {
            playTone(notes[i % notes.length], 0.5, 'triangle', 0.2);
            i++;
        }, 400);
    }
    function stopMelody() { if (melodyTimer) clearInterval(melodyTimer); }

    /* --- è®¡æ—¶å™¨é©±åŠ¨ --- */
    let ticker = null;
    let alarmAutoTimer = null;

    const app = {
        init() {
            data.refreshDaily();
            this.render();
            ticker = setInterval(() => this.tick(), 1000);
            window.addEventListener('focus', () => { data.refreshDaily(); this.render(); });
        },

        render() {
            const el = id => document.getElementById(id);
            if(!el('lvBadge')) return;
            ['SMALL','MEDIUM','LARGE','GREEN'].forEach(k => el('inv-'+k).innerText = state.inv[k]);
            const lv = Math.floor(state.xp / 6000); const curXP = state.xp % 6000;
            el('lvBadge').innerText = `LV${lv}`;
            el('xpText').innerText = `${curXP}/6000`;
            el('xpFill').style.width = `${(curXP / 6000) * 100}%`;
            el('progLabel').innerText = `æ‰“å¡ ${state.todayMins}/15m`;
            el('progFill').style.width = `${Math.min(100,(state.todayMins/15)*100)}%`;
            el('shopThreshold').innerText = `${state.inv.LARGE} / 4`;
            el('shopStartBtn').style.opacity = state.inv.LARGE < 4 ? "0.3" : "1";
            el('streakDisplay').innerText = `${state.streak} å¤©è¿èƒœ`;
            el('cycleDisplay').innerText = `ç¬¬ ${state.streak}/30 å¤©å‘¨æœŸ`;
            this.drawBlocks(); this.drawCal(); this.updateTimerCard();
        },

        drawBlocks() {
            const list = document.getElementById('actionList'); list.innerHTML = '';
            state.blocks.forEach((b, idx) => {
                const div = document.createElement('div');
                div.className = 'action-card'; div.draggable = true;
                div.innerHTML = `
                    <div class="drag-handle"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 9h14M5 15h14"/></svg></div>
                    <div class="action-icon">${b.icon}</div>
                    <div class="action-info"><div class="action-name">${b.name}</div><div class="action-meta">âŒ› ${b.duration}m Â· ğŸ ${b.reward}</div></div>
                    <button class="play-btn" onclick="app.handleWorkClick('${b.id}')"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="4"><path d="M5 3l14 9-14 9V3z"/></svg></button>
                    <button class="del-btn" onclick="app.delTask('${b.id}')">âœ•</button>
                `;
                div.ondragstart = (e) => { e.dataTransfer.setData('idx', idx); div.classList.add('dragging'); };
                div.ondragend = () => div.classList.remove('dragging');
                div.ondragover = (e) => e.preventDefault();
                div.ondrop = (e) => {
                    const from = e.dataTransfer.getData('idx');
                    const item = state.blocks.splice(from, 1)[0];
                    state.blocks.splice(idx, 0, item);
                    data.save(); this.render();
                };
                list.appendChild(div);
            });
        },

        drawCal() {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            for(let i=20; i>=0; i--) {
                const d = new Date(); d.setDate(new Date().getDate()-i);
                const ds = d.toISOString().split('T')[0];
                const div = document.createElement('div');
                div.className = `calendar-day ${state.history.includes(ds) ? 'checked' : ''}`;
                div.innerText = d.getDate(); grid.appendChild(div);
            }
        },

        handleWorkClick(id) { 
            const b = state.blocks.find(x => x.id === id);
            this.showModal('å¼€å¯ä¸“æ³¨', `å³åˆ»æ‰§è¡Œã€Œ${b.name}ã€ï¼Œæ‰‹æœºå°†ä¿æŒå¸¸äº®ã€‚`, () => this.startWork(id)); 
        },

        handleRestClick(type) { 
            if(state.inv[type] <= 0) return;
            const ds = { SMALL:5, MEDIUM:10, LARGE:60, GREEN:30 };
            const names = { SMALL:'å°ç•ªèŒ„', MEDIUM:'ä¸­ç•ªèŒ„', LARGE:'å¤§ç•ªèŒ„', GREEN:'é™æ—¶é’ç•ªèŒ„' };
            this.showModal('é“å…·ä¼‘æ¯', `æ¶ˆè€— 1 ä¸ª${names[type]}ï¼Œä¼‘æ¯ ${ds[type]} åˆ†é’Ÿã€‚`, () => {
                this.closeModal(); state.inv[type]--;
                this.prep(() => {
                    state.timer = { running: true, paused: false, mode: 'rest', targetEndTime: Date.now() + ds[type]*60000, sec: ds[type]*60, b: {name:'æ”¾æ¾æ—¶é—´', icon:'â˜•'} };
                    requestWakeLock();
                });
            });
        },

        handlePoolClick() {
            if(state.inv.LARGE < 4) return;
            this.showModal('è¿›å…¥ä¼‘æ¯å®¤', 'è‡ªç”±æ¨¡å¼ï¼šç»“æŸåæŒ‰æ¯”ä¾‹æ¶ˆè€—å¤§ç•ªèŒ„åº“å­˜ï¼Œä½™æ•°è½¬XPã€‚', () => {
                this.closeModal();
                this.prep(() => {
                    state.timer = { running: true, paused: false, mode: 'pool', targetEndTime: Date.now(), sec: 0, b: {name:'è‡ªç”±è®¡æ—¶', icon:'â˜•'} };
                    requestWakeLock();
                });
            });
        },

        startWork(id) {
            const b = state.blocks.find(x => x.id === id);
            this.closeModal();
            this.prep(() => {
                state.timer = { running: true, paused: false, mode: 'work', targetEndTime: Date.now() + b.duration*60000, sec: b.duration*60, b: b };
                requestWakeLock();
            });
        },

        tick() {
            if(state.timer.running && !state.timer.paused) {
                const now = Date.now();
                if(state.timer.mode === 'pool') {
                    state.timer.sec = Math.floor((now - state.timer.targetEndTime)/1000);
                } else {
                    const diff = Math.ceil((state.timer.targetEndTime - now)/1000);
                    if(diff <= 0) { state.timer.sec = 0; this.onDone(); } 
                    else { state.timer.sec = diff; }
                }
                this.updateTimerCard();
            }
        },

        onDone() {
            let msg = "";
            if(state.timer.mode === 'work') {
                state.todayMins += state.timer.b.duration;
                state.inv[state.timer.b.reward]++;
                msg = data.checkIn() || `ä»»åŠ¡è¾¾æˆï¼è·å¾— 1 ä¸ª${state.timer.b.reward}`;
            }
            this.quitTimer(); this.triggerAlarm(msg);
        },

        finishPool() {
            const elapsed = state.timer.sec;
            let totalSec = (state.inv.LARGE * 3600) + (state.inv.MEDIUM * 600) + (state.inv.SMALL * 300);
            let remain = Math.max(0, totalSec - elapsed);
            state.inv.LARGE = Math.floor(remain / 3600); remain %= 3600;
            state.inv.MEDIUM = Math.floor(remain / 600); remain %= 600;
            state.inv.SMALL = Math.floor(remain / 300); remain %= 300;
            data.addXP(remain); 
            this.quitTimer(); this.triggerAlarm(`ç»“ç®—æˆåŠŸï¼è·å¾— ${remain} XP`);
        },

        quitTimer() { state.timer.running = false; releaseWakeLock(); data.save(); this.render(); },
        togglePause() { getAudio(); if(!state.timer.paused) { state.timer.pausedSec = state.timer.sec; state.timer.paused = true; releaseWakeLock(); } else { state.timer.targetEndTime = state.timer.mode === 'pool' ? Date.now() - state.timer.pausedSec*1000 : Date.now() + state.timer.pausedSec*1000; state.timer.paused = false; requestWakeLock(); } this.render(); },

        updateTimerCard() {
            const card = document.getElementById('activeTimerCard'); if(!card) return;
            if(!state.timer.running) { card.style.display = 'none'; return; }
            card.style.display = 'block';
            const m = Math.floor(state.timer.sec/60); const s = state.timer.sec % 60;
            document.getElementById('t-clock').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            document.getElementById('t-mode').innerText = state.timer.mode === 'work' ? 'FOCUSING' : 'RESTING';
            document.getElementById('t-task').innerText = state.timer.b.name;
            document.getElementById('btnPause').innerText = state.timer.paused ? 'ç»§ç»­' : 'æš‚åœ';
            document.getElementById('t-btns-pool').className = state.timer.mode === 'pool' ? 'timer-btns' : 'timer-btns hidden';
            document.getElementById('t-btns-normal').className = state.timer.mode === 'pool' ? 'timer-btns hidden' : 'timer-btns';
        },

        triggerAlarm(msg) {
            const ui = document.getElementById('alarmUI'); ui.style.display = 'flex';
            document.getElementById('alarmRewardText').innerText = msg;
            startMelody(); this.startConfetti(); doVibrate();
            let timeLeft = 20;
            const label = document.getElementById('alarmTimerLabel');
            if(alarmAutoTimer) clearInterval(alarmAutoTimer);
            alarmAutoTimer = setInterval(() => {
                timeLeft--; 
                if(label) label.innerText = `${timeLeft}s åè‡ªåŠ¨å…³é—­`;
                if(timeLeft <= 0) this.closeAlarm();
            }, 1000);
        },

        closeAlarm() {
            stopMelody(); 
            if(alarmAutoTimer) clearInterval(alarmAutoTimer);
            if ('vibrate' in navigator) navigator.vibrate(0);
            document.getElementById('alarmUI').style.display = 'none'; this.render();
        },

        prep(cb) {
            getAudio(); const ui = document.getElementById('prepUI'); const num = document.getElementById('prepNum');
            ui.style.display = 'flex'; let c = 3; num.innerText = c;
            playTone(880, 0.1); 
            const t = setInterval(() => {
                c--; if(c<=0){ clearInterval(t); ui.style.display='none'; cb(); } 
                else { num.innerText=c; playTone(880, 0.1); } 
            }, 1000);
        },

        startConfetti() {
            const cvs = document.getElementById('confettiCanvas'); const ctx = cvs.getContext('2d');
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            let p = Array.from({length: 60}, () => ({ x: Math.random()*cvs.width, y: -20, s: Math.random()*7+3, c: `hsl(${Math.random()*360},70%,60%)`, v: Math.random()*3+2 }));
            const draw = () => {
                ctx.clearRect(0,0,cvs.width, cvs.height);
                p.forEach(i => { ctx.fillStyle = i.c; ctx.fillRect(i.x, i.y, i.s, i.s); i.y += i.v; if(i.y>cvs.height) i.y = -20; });
                if(document.getElementById('alarmUI').style.display === 'flex') requestAnimationFrame(draw);
            };
            draw();
        },

        /* --- UI åŠŸèƒ½ --- */
        switchTab(tab, el) { getAudio(); document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(`view-${tab}`).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); el.classList.add('active'); },
        openSheet() { getAudio(); document.getElementById('sheetOverlay').style.display='flex'; setTimeout(()=>document.getElementById('addSheet').classList.add('active'),10); },
        closeSheet() { document.getElementById('addSheet').classList.remove('active'); setTimeout(()=>document.getElementById('sheetOverlay').style.display='none',300); },
        setRew(r, el) { state.pendingRew = r; document.querySelectorAll('.rew-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); },
        addTask() {
            const n = document.getElementById('taskName').value; if(!n) return;
            state.blocks.push({ id: Date.now().toString(), name: n, duration: parseInt(document.getElementById('taskDur').value)||25, reward: state.pendingRew, icon: document.getElementById('taskIcon').value });
            data.save(); this.render(); this.closeSheet();
        },
        delTask(id) { state.blocks = state.blocks.filter(b=>b.id!==id); data.save(); this.render(); },
        showModal(title, desc, onOk) { document.getElementById('modalTitle').innerText = title; document.getElementById('modalDesc').innerText = desc; document.getElementById('modalOkBtn').onclick = () => { onOk(); this.closeModal(); }; document.getElementById('modalUI').style.display = 'flex'; },
        closeModal() { document.getElementById('modalUI').style.display = 'none'; },
        openDebug() { document.getElementById('debugUI').style.display='flex'; },
        skip() { if(state.timer.running) state.timer.targetEndTime = Date.now(); }
    };

    window.onload = () => app.init();
</script>
</body>
</html>